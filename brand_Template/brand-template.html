<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QA Audit Report</title>
  <link rel="icon" type="image/svg+xml" href="/api/assets/favicon.png" />
  <link rel="stylesheet" href="/api/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <div class="page-section cover-page">
    <div class="cover-content">
      <div class="cover-header">
    <div class="header-content">
          <div class="header-logo">
            <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="256" height="47" />
          </div>
          <div class="cover-date">
            Created <span id="currentDate"></span>
          </div>
        </div>
      </div>
      
      <div class="cover-main">
        <div class="cover-title">
          <h1 class="cover-subtitle">REPORT</h1>
          <h2 class="cover-main-title">QA Audit</h2>
          <p class="cover-url">
            <a href="{{siteUrl}}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">{{siteDisplay}}</a>
          </p>
        </div>
      </div>
      <div class="cover-footer">
        <div class="cover-brand">
        </div>
      </div>
    </div>
    
    <div class="page-footer">
      <div class="footer-content">
        
        <div class="footer-info">
          <span>Generated by White Label IQ</span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <div class="page-section">
    <div class="page-header">
      <div class="header-brand">
        <div class="header-title">
          <h1>Executive Summary</h1>
          <p class="header-subtitle">QA Audit Report</p>
        </div>
        <div class="header-logo-small">
          <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
        </div>
      </div>
    </div>

    <div class="executive-overview">
      <div class="overview-content">
        <h2>Audit Overview</h2>
        <p class="overview-description">
          This Quality Assurance (QA) audit was conducted to evaluate the <strong>{{projectName}}</strong> website across visual design, user interface behavior, device responsiveness, and core functionality. The objective is to identify and document usability problems, broken or incomplete elements, and layout/design inconsistencies before the site's public release or marketing efforts.
        </p>
      </div>
    </div>
    <div class="executive-overview">
      <div class="overview-content">
        <h2>Audit Scope</h2>
        <p class="overview-description">
          The QA team thoroughly reviewed the website across the following focus areas:
        </p>
        <ul class="space">
          <li><strong>Visual Design and Typography Consistency: </strong>Assessed font usage, heading structures, color palette, button styles, padding/margins, and image placements to maintain visual harmony throughout the site.</li>
          <li><strong>Functionality of Buttons, Links, and Forms: </strong>Checked all internal and external links, button interactions, hover states, form field behavior (including validation and error handling), and CTA performance.</li>
          <li><strong>Mobile and Tablet Responsiveness: </strong>Verified that the site adapts correctly to mobile and tablet screen sizes, with no content cutoffs, overlapping elements, or layout misalignment.</li>
          <li><strong>Content Layout and Readability: </strong>Reviewed spacing, alignment, and hierarchy of textual content to ensure clear flow and easy readability across different devices and screen widths.</li>
          <li><strong>Cross-Browser Compatibility: </strong>Tested the site on modern browsers (Chrome, Firefox, Safari, Edge) to detect any rendering issues, style inconsistencies, or JavaScript-related bugs.</li>
        </ul>
      </div>
    </div>
</div>

  <div class="page-section">
    <div class="page-header">
      <div class="header-brand">
        <div class="header-title">
          <h1>Executive Summary</h1>
          <p class="header-subtitle">QA Audit Report</p>
        </div>
        <div class="header-logo-small">
          <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
        </div>
      </div>
    </div>

    <div class="executive-overview">
      <div class="overview-content">
        <ul class="space">
          <li><strong>Visual Design and Typography Consistency: </strong>Assessed font usage, heading structures, color palette, button styles, padding/margins, and image placements to maintain visual harmony throughout the site.</li>
          <li><strong>Functionality of Buttons, Links, and Forms: </strong>Checked all internal and external links, button interactions, hover states, form field behavior (including validation and error handling), and CTA performance.</li>
          <li><strong>Mobile and Tablet Responsiveness: </strong>Verified that the site adapts correctly to mobile and tablet screen sizes, with no content cutoffs, overlapping elements, or layout misalignment.</li>
          <li><strong>Content Layout and Readability: </strong>Reviewed spacing, alignment, and hierarchy of textual content to ensure clear flow and easy readability across different devices and screen widths.</li>
          <li><strong>Cross-Browser Compatibility: </strong>Tested the site on modern browsers (Chrome, Firefox, Safari, Edge) to detect any rendering issues, style inconsistencies, or JavaScript-related bugs.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="page-section">
  <div class="page-header">
    <div class="header-brand">
      <div class="header-title">
        <h1>Key Highlights</h1>
        <p class="header-subtitle">QA Audit Report</p>
      </div>
      <div class="header-logo-small">
        <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
      </div>
    </div>
  </div>
  <div class="executive-overview">
    <div class="overview-content">
      <ul class="space">
        <li>Several pages are missing main heading tags (like H1), which are important for both users and search engines. </li>
        <li>The contact form is not working as expected â€” submissions do not go through.</li>
        <li>Design inconsistencies were found across pages, including buttons that look different, text not aligned, or spacing that feels uneven.</li>
        <li>Some important links are missing or lead to the wrong pages.</li>
        <li>On mobile devices, certain elements (like images or buttons) are not aligned properly or are hard to use.</li>
      </ul>
    </div>
  </div>
</div>

<div class="page-section">
  <div class="page-header">
    <div class="header-brand">
      <div class="header-title">
        <h1>Recommendations</h1>
        <p class="header-subtitle">Key Performance Indicators</p>
      </div>
      <div class="header-logo-small">
        <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
      </div>
    </div>
  </div>
  <div class="executive-overview">
    <div class="overview-content">
      <p class="overview-description">To prepare the website for a successful public launch, we recommend:</p>
      <ul class="space">
        <li>Fix all Critical and Moderate issues before launching or marketing the site</li>
        <li>Test all fixes again on mobile, tablet, and desktop after making changes</li>
        <li>Run a basic SEO review to address missing headings and page metadata</li>
        <li>Consider a more in-depth accessibility audit if you plan to meet ADA or WCAG standards</li>
        <li>Verify all contact forms and buttons are working smoothly on every page</li>
      </ul>
    </div>
  </div>
</div>

<div class="page-section">
  <div class="end-cover">
    <div class="end-header">
      <div class="end-logo">
        <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="256" height="47" />
      </div>
      <div class="end-date">
        <span>Report Generated: <span id="generatedDate"></span></span>
      </div>
    </div>

    <div class="end-content">
      <div class="end-title">
        <h1>QA Audit Report</h1>
        <h2>{{projectName}}</h2>
      </div>

      <div class="end-summary">
        <p>This QA Audit has identified key areas for improvement to ensure your software meets the highest standards of quality, reliability, and performance. The findings presented in this report provide a clear roadmap for enhancing the user experience and ensuring a robust, error-free product.</p>
        
        <p>We recommend prioritizing the critical and high-severity issues identified, as these have the most significant impact on software functionality and user satisfaction. The medium-severity issues, while less urgent, should also be addressed to achieve full quality assurance.</p>
      </div>

      <div class="end-footer">
        <p>Thank you for choosing White Label IQ for your QA Audit needs. We're committed to helping you create inclusive digital experiences.</p>
        <div class="signature">
            <div class="end-logo">
              <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="256" height="47" />
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="findingsContainer"></div>

<script>
  // Global variables to store the data
  let findingsData = [];
  let auditLogData = [];
  
  // Default data for audit log if not provided by server
  const defaultAuditLogData = [
    { pageUrl: '/', pageName: 'Home', issueType: 'Bug (UI)', description: 'Hero image not loading on mobile', priority: 'High', status: 'New', screenshot: 'View' },
    { pageUrl: '/products', pageName: 'Products', issueType: 'Content', description: 'Missing product descriptions', priority: 'Moderate', status: 'In Progress', screenshot: 'View' },
    { pageUrl: '/about-us', pageName: 'About', issueType: 'Bug (UI)', description: 'H1 tag is missing; affects SEO', priority: 'Moderate', status: 'New', screenshot: 'View' },
    { pageUrl: '/about-us', pageName: 'About', issueType: 'Bug (UI)', description: 'H2 font size inconsistent across pages', priority: 'Critical', status: 'New', screenshot: 'View' },
    { pageUrl: '/', pageName: 'Home', issueType: 'Bug (UI)', description: 'Logo link missing in footer', priority: 'Moderate', status: 'New', screenshot: 'View' },
    { pageUrl: '/contact', pageName: 'Contact Us', issueType: 'Bug (Functionality)', description: 'Contact form button not working', priority: 'Critical', status: 'In Progress', screenshot: 'Link' },
    { pageUrl: '/products', pageName: 'Products', issueType: 'Content', description: 'Product images not loading on mobile', priority: 'High', status: 'New', screenshot: 'View' },
    { pageUrl: '/blog', pageName: 'Blog', issueType: 'Performance', description: 'Page load time exceeds 5 seconds', priority: 'High', status: 'New', screenshot: 'View' },
    { pageUrl: '/checkout', pageName: 'Checkout', issueType: 'Bug (Functionality)', description: 'Coupon code field not accepting valid codes', priority: 'Critical', status: 'New', screenshot: 'View' },
    { pageUrl: '/account', pageName: 'My Account', issueType: 'Security', description: 'Password strength meter not working', priority: 'High', status: 'New', screenshot: 'View' }
  ];
  
  // Function to initialize the report with data
  function initializeReport() {
    try {
      console.log('Initializing report...');
      
      // Get data from window object (injected by server)
      findingsData = window.findingsData || [];
      auditLogData = window.auditLogData || [];
      
      console.log('Found findingsData with', findingsData.length, 'items');
      console.log('Found auditLogData with', auditLogData.length, 'items');
      
      // Generate tables with the data
      if (findingsData.length > 0) {
        console.log('Generating findings tables...');
        generateTables();
      } else {
        console.warn('No findings data available');
      }
      
      if (auditLogData.length > 0) {
        console.log('Generating audit log tables...');
        generateAuditLogTables();
      } else {
        console.warn('No audit log data available');
      }
      
      // Initialize charts if needed
      if (findingsData.length > 0) {
        console.log('Initializing severity chart...');
        initSeverityChart();
      }
      
      console.log('Report initialization complete');
    } catch (error) {
      console.error('Error initializing report:', error);
    }
  }

  // Function to create a page section with table
  function createPageSection(pageNumber, data, targetElement, isLastPage = false) {
    console.log(`Creating page ${pageNumber} with ${data.length} rows`);
    const section = document.createElement('div');
    section.className = 'page-section';
    
    // Create header for the section
    const header = document.createElement('div');
    header.className = 'page-header';
    header.innerHTML = `
      <div class="header-brand">
        <div class="header-title">
          <h1>Summary of Findings</h1>
          <p class="header-subtitle">QA Audit Report</p>
        </div>
        <div class="header-logo-small">
          <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
        </div>
      </div>
    `;
    
    // Create findings container with chart
    const container = document.createElement('div');
    container.className = 'findings-container';
    
    // Add chart container only on first page
    if (pageNumber === 1) {
      const chartContainer = document.createElement('div');
      chartContainer.className = 'chart-container';
      chartContainer.style.marginBottom = '30px';
      chartContainer.style.height = '300px';
      chartContainer.style.position = 'relative'; // Needed for Chart.js
      chartContainer.style.width = '100%';
      
      const canvas = document.createElement('canvas');
      canvas.id = 'severityChart';
      canvas.style.display = 'block';
      canvas.style.height = '300px';
      canvas.style.width = '100%';
      
      chartContainer.appendChild(canvas);
      container.appendChild(chartContainer);
      
          // Initialize the chart only on first page after a small delay
      // to ensure the canvas is in the DOM and has dimensions
      const initChart = () => {
        const canvas = document.getElementById('severityChart');
        if (canvas) {
          // Ensure the canvas has dimensions
          if (canvas.offsetWidth > 0 && canvas.offsetHeight > 0) {
            initSeverityChart();
          } else {
            // If dimensions aren't ready, try again after a short delay
            setTimeout(initChart, 100);
          }
        } else {
          console.error('Canvas element not found for chart initialization');
        }
      };
      
      // Start the initialization process
      setTimeout(initChart, 100);
    }
    
    // Only add the table if there are rows to display
    if (data.length > 0) {
      container.innerHTML += `
        <h2>Summary of Findings</h2>
        <table class="findings-table">
          <thead>
            <tr>
              <th>Page Name</th>
              <th>Total Issues</th>
              <th>Critical</th>
              <th>Important</th>
              <th>Normal</th>
              <th>Minor</th>
              <th>Not Set</th>
            </tr>
          </thead>
          <tbody id="findingsTableBody-${pageNumber}"></tbody>
        </table>
      `;
    }
    
    // Add severity content based on row count or if it's the last page
    const shouldShowSeverity = (data.length <= 3 && pageNumber === 1) || isLastPage;
    
    if (shouldShowSeverity) {
      const severityContent = document.createElement('div');
      severityContent.className = 'severity-definitions';
      severityContent.innerHTML = `
       <div class="executive-overview">
        <div class="overview-content">
          <h2>Severity Definitions</h2>
          <ul class="space" style="margin-top: 10px;">
            <li><strong>Critical: </strong>Needs urgent fix before launch</li>
            <li><strong>Important: </strong>High priority. Should be addressed promptly as it can impact user experience or business goals.</li>
            <li><strong>Normal: </strong>Should be fixed soon, but not launch-blocking</li>
            <li><strong>Minor: </strong>Small issues that won't impact function, but polish the experience</li>
            <li><strong>Not Set: </strong>No priority assigned yet. Needs review and categorization.</li>
          </ul>
        </div>
      </div>`;
      container.appendChild(severityContent);
    }
    
    section.appendChild(header);
    section.appendChild(container);
    
    targetElement.appendChild(section);
    
    // Populate the table with data if there are rows
    if (data.length > 0) {
      const tbody = document.getElementById(`findingsTableBody-${pageNumber}`);
      if (tbody) {  // Make sure tbody exists
        data.forEach(item => {
          const row = document.createElement('tr');
          // Check the structure of the item to handle different data formats
          if (item.pageName !== undefined) {
            // This is the summary data
            row.innerHTML = `
              <td>${item.pageName || 'N/A'}</td>
              <td>${item.total || 0}</td>
              <td>${item.critical || 0}</td>
              <td>${item.important || 0}</td>
              <td>${item.normal || 0}</td>
              <td>${item.minor || 0}</td>
              <td>${item.notSet || 0}</td>
            `;
          } else if (item.url) {
            // This is the detailed findings data
            const severity = item.severity || 'Not Set';
            row.innerHTML = `
              <td>${item.pageName || item.url}</td>
              <td>${item.total || 1}</td>
              <td>${severity === 'Critical' ? 1 : 0}</td>
              <td>${severity === 'Important' ? 1 : 0}</td>
              <td>${severity === 'Normal' ? 1 : 0}</td>
              <td>${severity === 'Minor' ? 1 : 0}</td>
              <td>${severity === 'Not Set' ? 1 : 0}</td>
            `;
          }
          tbody.appendChild(row);
        });
      }
    }
  }

  // Function to check if there's enough space for Severity Definitions
  function shouldAddNewPage(rowsOnPage) {
    // If there are more than 12 rows, we need a new page for Severity Definitions
    return rowsOnPage > 12;
  }

  // Function to check if we need a new page for Severity Definitions
  function needsNewPageForSeverity(rowsOnPage) {
    // If there are more than 10 rows, we need a new page for Severity Definitions
    return rowsOnPage > 10;
  }

  // Function to process findings data into a summary format
  function processFindingsData(findings) {
    const summary = {};
    
    findings.forEach(item => {
      const pageName = item.pageName || 'Unknown Page';
      const severity = item.severity || 'Not Set';
      
      if (!summary[pageName]) {
        summary[pageName] = {
          pageName: pageName,
          total: 0,
          critical: 0,
          important: 0,
          normal: 0,
          minor: 0,
          notSet: 0
        };
      }
      
      // Increment the appropriate counters
      summary[pageName].total++;
      switch(severity.toLowerCase()) {
        case 'critical':
          summary[pageName].critical++;
          break;
        case 'important':
          summary[pageName].important++;
          break;
        case 'normal':
          summary[pageName].normal++;
          break;
        case 'minor':
          summary[pageName].minor++;
          break;
        default:
          summary[pageName].notSet++;
      }
    });
    
    // Convert the summary object to an array
    return Object.values(summary);
  }

  // Function to generate tables with pagination
  function generateTables() {
    console.log('Generating tables with findings data:', findingsData);
    
    // Process the findings data into a summary format
    const processedData = processFindingsData(findingsData);
    
    // If no data, show a message
    if (processedData.length === 0) {
      const container = document.getElementById('findingsContainer');
      if (container) {
        container.innerHTML = '<p>No findings data available. Please check your BugHerd project for issues.</p>';
      }
      return;
    }
    
    // Check if we should show everything on a single page with Severity Definitions
    if (processedData.length <= 3) {
      const findingsContainer = document.getElementById('findingsContainer');
      if (!findingsContainer) return;
      findingsContainer.innerHTML = '';
      
      // Create a single page with all data
      createPageSection(1, processedData, findingsContainer, false);
      
      // Add Severity Definitions on the same page after the table
      const severitySection = document.createElement('div');
      severitySection.className = 'severity-definitions';
      severitySection.innerHTML = `
        <div class="executive-overview">
          <div class="overview-content">
            <h2>Severity Definitions</h2>
            <ul class="space" style="margin-top: 10px;">
              <li><strong>Critical: </strong>Needs urgent fix before launch</li>
              <li><strong>Important: </strong>High priority. Should be addressed promptly as it can impact user experience or business goals.</li>
              <li><strong>Normal: </strong>Should be fixed soon, but not launch-blocking</li>
              <li><strong>Minor: </strong>Small issues that won't impact function, but polish the experience</li>
              <li><strong>Not Set: </strong>No priority assigned yet. Needs review and categorization.</li>
            </ul>
          </div>
        </div>`;
      findingsContainer.appendChild(severitySection);
      return;
    }
    
    // For more than 3 rows, use the pagination logic
    const firstPageRows = 10; // First page shows 10 rows
    const subsequentPageRows = 18; // Middle pages show up to 18 rows
    
    // Calculate total pages with different row counts
    let remainingRows = processedData.length;
    let totalPages = 0;
    let pageRowCounts = [];
    
    // First page gets firstPageRows (10) rows if possible
    if (remainingRows > 0) {
      const rowsForFirstPage = Math.min(firstPageRows, remainingRows);
      pageRowCounts.push(rowsForFirstPage);
      remainingRows -= rowsForFirstPage;
      totalPages++;
    }
    
    // Distribute remaining rows across subsequent pages
    while (remainingRows > 0) {
      let rowsForThisPage = Math.min(subsequentPageRows, remainingRows);
      
      // If this is the last page of data
      if (remainingRows <= rowsForThisPage) {
        // If we need a new page for Severity Definitions
        if (needsNewPageForSeverity(rowsForThisPage)) {
          // Add current rows to a new page
          pageRowCounts.push(rowsForThisPage);
          // Add an empty page for Severity Definitions
          pageRowCounts.push(0);
          totalPages += 2;
        } else {
          // If it fits, add it as is
          pageRowCounts.push(rowsForThisPage);
          totalPages++;
        }
        remainingRows = 0;
      } else {
        // Regular middle page
        pageRowCounts.push(rowsForThisPage);
        remainingRows -= rowsForThisPage;
        totalPages++;
      }
    }
    
    // Remove any existing tables
    const findingsContainer = document.getElementById('findingsContainer');
    if (!findingsContainer) return;
    findingsContainer.innerHTML = '';
    
    // Create a page for each set of rows
    let currentIndex = 0;
    for (let i = 0; i < totalPages; i++) {
      const rowsToTake = pageRowCounts[i];
      const pageData = findingsData.slice(currentIndex, currentIndex + rowsToTake);
      const isLastPage = (i === totalPages - 1);
      createPageSection(i + 1, pageData, findingsContainer, isLastPage);
      currentIndex += rowsToTake;
    }
  } // End of generateTables function

  // Function to create audit log page section
  function createAuditLogPage(pageNumber, data, targetElement, isLastPage = false) {
    const section = document.createElement('div');
    section.className = 'page-section';
    
    // Create header for the section
    const header = document.createElement('div');
    header.className = 'page-header';
    header.innerHTML = `
      <div class="header-brand">
        <div class="header-title">
          <h1>Detailed Audit Log</h1>
          <p class="header-subtitle">QA Audit Report</p>
        </div>
        <div class="header-logo-small">
          <img src="https://www.whitelabeliq.com/wp-content/uploads/2022/12/logo.svg" alt="White Label IQ Logo" width="120" height="22" />
        </div>
      </div>
    `;
    
    // Create table container
    const container = document.createElement('div');
    container.className = 'findings-container';
    container.innerHTML = `
      <h2>Detailed Audit Log</h2>
      <table class="findings-table">
        <thead>
          <tr>
            <th>Page URL</th>
            <th>Page Name</th>
            <th>Issue Type</th>
            <th>Description</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Screenshot</th>
          </tr>
        </thead>
        <tbody id="auditLogTableBody-${pageNumber}"></tbody>
      </table>
    `;

    // Populate the table with data
    const tbody = container.querySelector(`#auditLogTableBody-${pageNumber}`);
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.pageUrl || ''}</td>
        <td>${item.pageName || ''}</td>
        <td>${item.issueType || ''}</td>
        <td>${item.description || ''}</td>
        <td><span class="priority-${(item.priority || '').toLowerCase().replace(' ', '-')}">${item.priority || ''}</span></td>
        <td><span class="status-${(item.status || '').toLowerCase().replace(' ', '-')}">${item.status || ''}</span></td>
        <td>${item.screenshot || ''}</td>
      `;
      tbody.appendChild(row);
    });

    // If this is the last page and we have rows, and there are more than 3 rows, 
    // add Severity Definitions on a new page
    if (isLastPage && data.length > 0 && processedData.length > 3) {
      const note = document.createElement('p');
      note.className = 'audit-log-note';
      // note.style.color = '#666';
      note.innerHTML = `
        <em>(Full table is available in the original 
        <a target="_blank" href="https://docs.google.com/spreadsheets/d/1qdvBcAQzfZ7uWuYJtdGbr13a4fSYYr_GT5aCzaKVtpo/edit?gid=1217729186#gid=1217729186">sheet</a> for reference.)</em>
      `;
      container.appendChild(note);
    }
    
    // Append header and container with table
    section.appendChild(header);
    section.appendChild(container);
    
    targetElement.appendChild(section);
  }

  // Function to generate audit log tables with pagination
  function generateAuditLogTables() {
    console.log('generateAuditLogTables called');
    const container = document.getElementById('auditLogContainer');
    if (!container) {
      console.error('auditLogContainer not found');
      return;
    }
    console.log('auditLogData length:', auditLogData.length);
    
    container.innerHTML = ''; // Clear existing content
    
    const rowsPerPage = 5; // Show 5 rows per page
    const totalPages = Math.ceil(auditLogData.length / rowsPerPage);
    console.log('Total pages:', totalPages);
    
    for (let i = 0; i < totalPages; i++) {
      const start = i * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = auditLogData.slice(start, end);
      const isLastPage = (i === totalPages - 1);
      console.log('Creating page', i, 'with data:', pageData);
      createAuditLogPage(i, pageData, container, isLastPage);
    }
  }

  // Function to count issues by severity
  function countIssuesBySeverity() {
    const counts = {
      critical: 0,
      important: 0,
      normal: 0,
      minor: 0,
      notset: 0
    };

    // Count issues from the findings data
    findingsData.forEach(item => {
      counts.critical += item.critical || 0;
      counts.important += item.important || 0;
      counts.normal += item.normal || 0;
      counts.minor += item.minor || 0;
      counts.notset += item.notSet || 0;
    });
    
    return counts;
  }

// Initialize the pie chart
function initSeverityChart() {
console.log('Initializing severity chart...');

const ctx = document.getElementById('severityChart');
if (!ctx) {
console.error('Canvas element not found');
return;
}

// Ensure canvas has dimensions
const container = ctx.parentElement;
console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);

if (container.offsetWidth === 0 || container.offsetHeight === 0) {
console.error('Chart container has no dimensions');
// Try again after a short delay
setTimeout(initSeverityChart, 100);
return;
}

try {
// Get the issue counts
const counts = countIssuesBySeverity();
const dataValues = [
counts.critical,
counts.important,
counts.normal,
counts.minor,
counts.notset
];

// Calculate total for percentages
const total = dataValues.reduce((a, b) => a + b, 0);

// Destroy existing chart if it exists
if (window.severityChart instanceof Chart) {
window.severityChart.destroy();
}

// Create the chart
window.severityChart = new Chart(ctx, {
type: 'pie',
data: {
labels: ['Critical', 'Important', 'Normal', 'Minor', 'Not Set'],
datasets: [{
data: dataValues,
backgroundColor: [
'#fecaca', // Critical - light red
'#fde68a', // Important - light yellow
'#bae6fd', // Normal - light blue
'#d1d5db', // Minor - light gray
'#f3f4f6'  // Not Set - lighter gray
],
borderWidth: 1,
borderColor: '#fff'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
interaction: {
  mode: 'nearest',
  intersect: false
},
onHover: (event, chartElement) => {
  if (window.matchMedia('print').matches) {
    event.native.target.style.cursor = 'default';
  }
},
animation: {
  onComplete: function() {
    if (window.matchMedia('print').matches) {
      this.options.animation.duration = 0;
    }
  }
},
plugins: {
legend: {
position: 'right',
labels: {
boxWidth: 20,
padding: 15,
font: {
size: 12
}
}
},
tooltip: {
callbacks: {
label: function(context) {
const label = context.label || '';
const value = context.raw || 0;
const percentage = Math.round((value / total) * 100) || 0;
return `${label}: ${value} (${percentage}%)`;
}
}
},
datalabels: {
formatter: (value, ctx) => {
if (value === 0) return ''; // Don't show 0 values
const percentage = Math.round((value / total) * 100);
return `${value}\n(${percentage}%)`;
},
color: '#fff',
font: {
weight: 'bold',
size: 12
},
textAlign: 'center',
textShadowColor: 'rgba(0,0,0,0.5)',
textShadowBlur: 3
}
},
layout: {
padding: 10
},
elements: {
arc: {
borderWidth: 2
}
}
},
plugins: [ChartDataLabels] // Add the datalabels plugin
});

console.log('Chart initialized successfully');
} catch (error) {
console.error('Error initializing chart:', error);
container.innerHTML = '<p>Error initializing chart. Please check console for details.</p>';
}
}

// Function to format date as 'DD MMM YYYY'
function formatDate(date) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const day = date.getDate().toString().padStart(2, '0');
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${day}, ${month} ${year}`;
}



// Set the current date in the cover and end section
const currentDate = new Date();
const dateElement = document.getElementById('currentDate');
const generatedDateElement = document.getElementById('generatedDate');

if (dateElement) {
  dateElement.textContent = formatDate(currentDate);
}

if (generatedDateElement) {
  generatedDateElement.textContent = formatDate(currentDate);
}
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM fully loaded');
  
  // Initialize the report with data
  initializeReport();
  
  // Find the Key Highlights section
  const keyHighlightsSection = Array.from(document.querySelectorAll('.page-section')).find(section => {
    const h1 = section.querySelector('h1');
    return h1 && h1.textContent.trim() === 'Key Highlights';
  });
  
  if (!keyHighlightsSection) {
    console.error('Key Highlights section not found');
    return;
  }
  
  console.log('Key Highlights section found:', keyHighlightsSection);
  
  // Create a container for both findings and audit log sections
  const sectionsContainer = document.createElement('div');
  sectionsContainer.className = 'sections-container';
  sectionsContainer.style.marginBottom = '40px';
  
  // Create and append the findings section with heading
  const findingsSection = document.createElement('div');
  
  const findingsContainer = document.createElement('div');
  findingsContainer.id = 'findingsContainer';
  findingsContainer.style.marginBottom = '40px';
  findingsSection.appendChild(findingsContainer);
  
  // Create and append the audit log section with heading
  const auditLogSection = document.createElement('div');
  auditLogSection.style.marginTop = '40px';
  
  const auditLogContainer = document.createElement('div');
  auditLogContainer.id = 'auditLogContainer';
  auditLogSection.appendChild(auditLogContainer);
  
  // Add both sections to the container
  sectionsContainer.appendChild(findingsSection);
  sectionsContainer.appendChild(auditLogSection);
  
  // Insert the container before the Key Highlights section
  keyHighlightsSection.parentNode.insertBefore(sectionsContainer, keyHighlightsSection);
  
  try {
    console.log('Initializing content...');
    
    // Initialize the content in the correct order
    console.log('Initializing severity chart...');
    initSeverityChart();
    
    console.log('Generating findings tables...');
    generateTables();
    
    console.log('Generating audit log tables...');
    generateAuditLogTables();
    
    console.log('Initialization complete');
  } catch (error) {
    console.error('Error during initialization:', error);
  }
  });
</script>
</body>
</html>
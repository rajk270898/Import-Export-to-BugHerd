<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugHerd CSV/Excel Uploader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .upload-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        .logo img {
            max-width: 200px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e9ecef;
        }
        #fileInput {
            display: none;
        }
        .file-info {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .btn-upload {
            width: 100%;
            padding: 0.75rem;
            font-weight: 500;
        }
        #results {
            margin-top: 2rem;
            display: none;
        }
        .progress {
            height: 10px;
            margin-bottom: 1rem;
        }
        .result-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .result-item.success {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .result-item.error {
            background-color: #f8d7da;
            color: #842029;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.2rem solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #0d6efd;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <div class="logo">
                <h2>BugHerd CSV/Excel Uploader</h2>
                <p class="text-muted">Upload your bug reports directly to BugHerd</p>
            </div>

            <div class="form-group">
                <label for="projectSelect" class="form-label">Select Project</label>
                <div class="input-group">
                    <select class="form-select" id="projectSelect" required>
                        <option value="" selected disabled>Loading projects...</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="refreshProjects">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="form-text">Select the project where bugs should be created</div>
            </div>

            <div class="upload-area" id="dropArea">
                <input type="file" id="fileInput" accept=".csv, .xlsx">
                <div class="mb-3">
                    <i class="bi bi-cloud-upload" style="font-size: 2.5rem; color: #0d6efd;"></i>
                    <h5>Drag & Drop your file here</h5>
                    <p class="text-muted">or click to browse</p>
                </div>
                <button class="btn btn-primary" id="browseBtn">Select File</button>
                <div class="file-info" id="fileInfo">No file selected</div>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-success btn-upload" id="uploadBtn" disabled>
                    <span id="uploadBtnText">Upload to BugHerd</span>
                    <span id="uploadBtnSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
            </div>

            <div class="progress mt-3" style="display: none;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>

            <div id="results">
                <h5>Upload Results</h5>
                <div id="resultsList"></div>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Debug Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button id="fetchProjectsBtn" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-repeat"></i> Fetch All Projects
                    </button>
                    <small class="text-muted ms-2">Click to refresh project list from BugHerd</small>
                </div>
                <div id="projectsList" class="mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Click "Fetch All Projects" to load project information
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadBtnText = document.getElementById('uploadBtnText');
            const uploadBtnSpinner = document.getElementById('uploadBtnSpinner');
            const fileInfo = document.getElementById('fileInfo');
            const progressBar = document.querySelector('.progress');
            const progressBarFill = document.getElementById('progressBar');
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');
            const projectSelect = document.getElementById('projectSelect');
            const refreshProjectsBtn = document.getElementById('refreshProjects');
            
            let selectedFile = null;
            let projects = [];

            // Debug section elements
            const fetchProjectsBtn = document.getElementById('fetchProjectsBtn');
            const projectsListDiv = document.getElementById('projectsList');

            // Fetch all projects button click handler
            fetchProjectsBtn.addEventListener('click', fetchAllProjects);

            // Function to fetch all projects with details
            async function fetchAllProjects() {
                try {
                    fetchProjectsBtn.disabled = true;
                    fetchProjectsBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                    
                    const response = await fetch('/api/projects/list');
                    const data = await response.json();
                    
                    if (data.success && data.projects) {
                        renderProjectsList(data.projects);
                    } else {
                        throw new Error(data.error || 'Failed to fetch projects');
                    }
                } catch (error) {
                    console.error('Error fetching projects:', error);
                    projectsListDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                            ${error.details ? `<div class="mt-2"><small>${JSON.stringify(error.details)}</small></div>` : ''}
                        </div>`;
                } finally {
                    fetchProjectsBtn.disabled = false;
                    fetchProjectsBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Fetch All Projects';
                }
            }

            // Function to render projects list
            function renderProjectsList(projects) {
                if (!Array.isArray(projects) || projects.length === 0) {
                    projectsListDiv.innerHTML = '<div class="alert alert-warning">No projects found in your BugHerd account</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Project ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Dev URL</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                projects.forEach(project => {
                    html += `
                        <tr>
                            <td><code>${project.id}</code></td>
                            <td>${escapeHtml(project.name || 'N/A')}</td>
                            <td><span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status || 'unknown'}</span></td>
                            <td><a href="${project.devurl || '#'}" target="_blank">${project.devurl || 'N/A'}</a></td>
                            <td>${project.created_at ? new Date(project.created_at).toLocaleString() : 'N/A'}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-muted">
                        <small>Found ${projects.length} project(s)</small>
                    </div>
                `;

                projectsListDiv.innerHTML = html;
            }

            // Helper function to escape HTML
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Load projects when page loads
            loadProjects();

            // Handle refresh projects button click
            refreshProjectsBtn.addEventListener('click', loadProjects);

            // Function to load projects from BugHerd
            async function loadProjects() {
                try {
                    projectSelect.disabled = true;
                    projectSelect.innerHTML = '<option value="">Loading projects...</option>';
                    refreshProjectsBtn.disabled = true;
                    
                    console.log('Fetching projects from server...');
                    const response = await fetch('/api/projects');
                    const data = await response.json();
                    
                    console.log('API Response:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data
                    });
                    
                    if (data && data.success !== false && Array.isArray(data.projects)) {
                        projects = data.projects;
                        renderProjects();
                        
                        if (projects.length === 0) {
                            showError('No projects found in your BugHerd account');
                        }
                    } else {
                        const errorMsg = data.error || 'Failed to load projects';
                        console.error('API Error:', data.details || 'No details');
                        
                        let errorMessage = errorMsg;
                        if (response.status === 401) {
                            errorMessage = 'Authentication failed. Please check your BugHerd API key in the .env file.';
                        } else if (response.status >= 500) {
                            errorMessage = 'Server error. Please try again later.';
                        }
                        
                        showError(`${errorMessage} (Status: ${response.status})`);
                        
                        // Show additional debug info in console
                        console.debug('API Response:', {
                            status: response.status,
                            statusText: response.statusText,
                            data: data
                        });
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                    let errorMessage = 'Failed to connect to the server. ';
                    
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'Please check your internet connection and make sure the server is running.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    showError(errorMessage);
                } finally {
                    projectSelect.disabled = false;
                    refreshProjectsBtn.disabled = false;
                }
            }

            // Function to show error message
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.textContent = message;
                resultsList.appendChild(errorDiv);
                resultsDiv.style.display = 'block';
            }

            // Function to render projects in the select dropdown
            function renderProjects() {
                if (!Array.isArray(projects) || projects.length === 0) {
                    projectSelect.innerHTML = '<option value="">No projects available</option>';
                    return;
                }

                let options = '<option value="" disabled selected>Select a project</option>';
                projects.forEach(project => {
                    const projectName = project.name || `Project ${project.id}`;
                    options += `<option value="${project.id}">${projectName}</option>`;
                });
                
                projectSelect.innerHTML = options;
            }

            // Handle drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('dragover');
            }

            function unhighlight() {
                dropArea.classList.remove('dragover');
            }

            // Handle dropped files
            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // Handle file selection via button
            browseBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', function() {
                handleFiles(this.files);
            });

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExt === 'csv' || fileExt === 'xlsx') {
                        selectedFile = file;
                        fileInfo.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                        updateUploadButtonState();
                    } else {
                        alert('Please select a .csv or .xlsx file');
                    }
                }
            }

            // Handle project selection change
            projectSelect.addEventListener('change', updateUploadButtonState);

            // Update upload button state based on file and project selection
            function updateUploadButtonState() {
                uploadBtn.disabled = !(selectedFile && projectSelect.value);
            }

            // Handle upload button click
            uploadBtn.addEventListener('click', uploadFile);

            async function uploadFile() {
                if (!selectedFile) {
                    showError('Please select a file first');
                    return;
                }

                const projectId = projectSelect.value;
                if (!projectId) {
                    showError('Please select a project first');
                    return;
                }

                // Clear previous results
                resultsList.innerHTML = '';
                resultsDiv.style.display = 'block';

                // Disable form elements during upload
                const formElements = [projectSelect, fileInput, browseBtn, uploadBtn];
                formElements.forEach(el => el.disabled = true);
                
                // Show loading state
                uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('projectId', projectId);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        // Show success message with results
                        const successCount = result.results.filter(r => r.status === 'success').length;
                        const errorCount = result.results.length - successCount;
                        
                        const successItem = document.createElement('div');
                        successItem.className = 'alert alert-success';
                        successItem.innerHTML = `
                            <strong>Upload Complete!</strong>
                            <div>Successfully processed ${successCount} of ${result.results.length} bugs</div>
                            ${errorCount > 0 ? `<div class="text-danger">${errorCount} bugs failed to upload</div>` : ''}
                        `;
                        resultsList.appendChild(successItem);
                        
                        // Show detailed results
                        const resultsTable = document.createElement('div');
                        resultsTable.className = 'mt-3';
                        resultsTable.innerHTML = `
                            <h6>Upload Results:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Bug ID</th>
                                            <th>Status</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.results.map(item => `
                                            <tr class="${item.status === 'success' ? 'table-success' : 'table-danger'}">
                                                <td>${item.id || 'N/A'}</td>
                                                <td>${item.status === 'success' ? '✅ Success' : '❌ Failed'}</td>
                                                <td>
                                                    ${item.status === 'success' 
                                                        ? `<a href="${item.url}" target="_blank">View in BugHerd</a>` 
                                                        : (item.error || 'Unknown error')}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        resultsList.appendChild(resultsTable);
                        
                    } else {
                        throw new Error(result.error || 'Failed to upload file');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    const errorItem = document.createElement('div');
                    errorItem.className = 'alert alert-danger';
                    errorItem.innerHTML = `
                        <strong>Error:</strong> ${error.message}
                        ${error.response ? `<div><small>Status: ${error.response.status} ${error.response.statusText}</small></div>` : ''}
                    `;
                    resultsList.appendChild(errorItem);
                } finally {
                    // Re-enable form elements
                    formElements.forEach(el => el.disabled = false);
                    
                    // Reset button state
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Upload to BugHerd';
                    
                    // Clear file input
                    fileInput.value = '';
                    selectedFile = null;
                    fileInfo.textContent = '';
                    updateUploadButtonState();
                }
            }

            function updateProgress(percent) {
                progressBarFill.style.width = `${percent}%`;
                progressBarFill.setAttribute('aria-valuenow', percent);
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>
